/**
 * FIXED RATES SECTION FOR SETTINGS PAGE
 * 
 * Key fixes:
 * 1. Each duration has its own minimum slider value
 * 2. Audio rates are auto-derived at 70% of video rates
 * 3. Sliders paired: Video rate on left, derived Audio rate on right
 * 4. Visual layout improved for clarity
 */

import { useState, useEffect, useMemo } from "react";
import { useAuth } from "@/contexts/AuthContext";
import { supabase } from "@/integrations/supabase/client";
import { toast } from "sonner";

import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { Slider } from "@/components/ui/slider";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Gem, Video, Phone, Save, Loader2 } from "lucide-react";
import { cn } from "@/lib/utils";

// ✅ FIXED: Correct minimum rates per duration
const RATE_CONFIG = {
  15: { min: 200, max: 900, label: "15 min" },
  30: { min: 280, max: 900, label: "30 min" },
  60: { min: 392, max: 900, label: "60 min" },
  90: { min: 412, max: 900, label: "90 min" },
} as const;

// Audio is 70% of video
const AUDIO_MULTIPLIER = 0.70;

function deriveAudioRate(videoRate: number): number {
  return Math.round(videoRate * AUDIO_MULTIPLIER);
}

// Calculate USD from credits
function creditsToUSD(credits: number, earnerShare: number = 0.70): string {
  const usd = credits * 0.10 * earnerShare;
  return `$${usd.toFixed(2)}`;
}

interface RatesSectionProps {
  onSave?: () => void;
}

export default function RatesSection({ onSave }: RatesSectionProps) {
  const { user, profile, refreshProfile } = useAuth();
  const [saving, setSaving] = useState(false);

  // Video rates state
  const [video15Rate, setVideo15Rate] = useState(RATE_CONFIG[15].min);
  const [video30Rate, setVideo30Rate] = useState(RATE_CONFIG[30].min);
  const [video60Rate, setVideo60Rate] = useState(RATE_CONFIG[60].min);
  const [video90Rate, setVideo90Rate] = useState(RATE_CONFIG[90].min);

  // Load existing rates from profile
  useEffect(() => {
    if (profile) {
      setVideo15Rate((profile as any).video_15min_rate || RATE_CONFIG[15].min);
      setVideo30Rate(profile.video_30min_rate || RATE_CONFIG[30].min);
      setVideo60Rate(profile.video_60min_rate || RATE_CONFIG[60].min);
      setVideo90Rate((profile as any).video_90min_rate || RATE_CONFIG[90].min);
    }
  }, [profile]);

  // Derived audio rates (auto-calculated, not editable)
  const audio15Rate = useMemo(() => deriveAudioRate(video15Rate), [video15Rate]);
  const audio30Rate = useMemo(() => deriveAudioRate(video30Rate), [video30Rate]);
  const audio60Rate = useMemo(() => deriveAudioRate(video60Rate), [video60Rate]);
  const audio90Rate = useMemo(() => deriveAudioRate(video90Rate), [video90Rate]);

  // Handler for rate changes with min/max enforcement
  const handleRateChange = (
    duration: 15 | 30 | 60 | 90,
    value: number,
    setter: (v: number) => void
  ) => {
    const config = RATE_CONFIG[duration];
    const clampedValue = Math.max(config.min, Math.min(config.max, value));
    setter(clampedValue);
  };

  // Save rates
  const handleSave = async () => {
    if (!user) return;
    setSaving(true);

    try {
      const { error } = await supabase
        .from("profiles")
        .update({
          video_15min_rate: video15Rate,
          video_30min_rate: video30Rate,
          video_60min_rate: video60Rate,
          video_90min_rate: video90Rate,
          updated_at: new Date().toISOString(),
        })
        .eq("id", user.id);

      if (error) throw error;

      await refreshProfile();
      toast.success("Rates saved!");
      onSave?.();
    } catch (error: any) {
      toast.error(error.message || "Failed to save rates");
    } finally {
      setSaving(false);
    }
  };

  // Rate card component
  const RateCard = ({
    duration,
    videoRate,
    audioRate,
    onVideoChange,
  }: {
    duration: 15 | 30 | 60 | 90;
    videoRate: number;
    audioRate: number;
    onVideoChange: (value: number) => void;
  }) => {
    const config = RATE_CONFIG[duration];

    return (
      <div className="p-4 rounded-xl bg-white/[0.02] border border-white/10 space-y-4">
        {/* Header */}
        <div className="flex items-center justify-between">
          <h3 className="font-semibold text-white text-lg">{config.label}</h3>
          <Badge variant="outline" className="text-white/50 border-white/20">
            {config.min} - {config.max} credits
          </Badge>
        </div>

        {/* Video Rate */}
        <div className="space-y-3">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-2">
              <Video className="w-4 h-4 text-rose-400" />
              <Label className="text-white/70">Video</Label>
            </div>
            <div className="flex items-center gap-2">
              <Input
                type="number"
                value={videoRate}
                onChange={(e) => onVideoChange(Number(e.target.value))}
                min={config.min}
                max={config.max}
                className="w-20 h-8 text-center bg-white/5 border-white/10 text-white text-sm"
              />
              <span className="text-xs text-white/50">credits</span>
            </div>
          </div>
          
          <Slider
            value={[videoRate]}
            onValueChange={([v]) => onVideoChange(v)}
            min={config.min}
            max={config.max}
            step={10}
            className="w-full"
          />
          
          <div className="flex justify-between text-xs text-white/40">
            <span>{config.min}</span>
            <span className="text-green-400">You earn: {creditsToUSD(videoRate)}</span>
            <span>{config.max}</span>
          </div>
        </div>

        {/* Audio Rate (derived, read-only) */}
        <div className="pt-3 border-t border-white/5">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-2">
              <Phone className="w-4 h-4 text-purple-400" />
              <Label className="text-white/50">Audio</Label>
              <Badge variant="outline" className="text-xs text-white/30 border-white/10">
                70% of video
              </Badge>
            </div>
            <div className="flex items-center gap-3">
              <span className="text-white/70 font-medium">{audioRate} credits</span>
              <span className="text-xs text-green-400/70">{creditsToUSD(audioRate)}</span>
            </div>
          </div>
        </div>
      </div>
    );
  };

  return (
    <Card className="bg-white/[0.02] border-rose-500/20">
      <CardHeader>
        <div className="flex items-center justify-between">
          <div>
            <CardTitle className="text-white flex items-center gap-2">
              <Gem className="w-5 h-5 text-rose-400" />
              Your Rates
            </CardTitle>
            <CardDescription className="text-white/50 mt-1">
              Set your video date rates. Audio rates are automatically 70% of video.
              <br />
              <span className="text-xs">1 credit = $0.10 • You earn 70% ($0.07/credit)</span>
            </CardDescription>
          </div>
          <Button
            onClick={handleSave}
            disabled={saving}
            className="bg-gradient-to-r from-rose-500 to-purple-500 hover:from-rose-400 hover:to-purple-400"
          >
            {saving ? (
              <Loader2 className="w-4 h-4 animate-spin mr-2" />
            ) : (
              <Save className="w-4 h-4 mr-2" />
            )}
            Save Rates
          </Button>
        </div>
      </CardHeader>

      <CardContent>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <RateCard
            duration={15}
            videoRate={video15Rate}
            audioRate={audio15Rate}
            onVideoChange={(v) => handleRateChange(15, v, setVideo15Rate)}
          />
          <RateCard
            duration={30}
            videoRate={video30Rate}
            audioRate={audio30Rate}
            onVideoChange={(v) => handleRateChange(30, v, setVideo30Rate)}
          />
          <RateCard
            duration={60}
            videoRate={video60Rate}
            audioRate={audio60Rate}
            onVideoChange={(v) => handleRateChange(60, v, setVideo60Rate)}
          />
          <RateCard
            duration={90}
            videoRate={video90Rate}
            audioRate={audio90Rate}
            onVideoChange={(v) => handleRateChange(90, v, setVideo90Rate)}
          />
        </div>

        {/* Summary */}
        <div className="mt-6 p-4 rounded-xl bg-gradient-to-r from-rose-500/10 to-purple-500/10 border border-rose-500/20">
          <h4 className="font-medium text-white mb-3">Rate Summary</h4>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
            <div>
              <span className="text-white/50 block">15 min</span>
              <span className="text-white">Video: {video15Rate}c</span>
              <span className="text-white/50 block">Audio: {audio15Rate}c</span>
            </div>
            <div>
              <span className="text-white/50 block">30 min</span>
              <span className="text-white">Video: {video30Rate}c</span>
              <span className="text-white/50 block">Audio: {audio30Rate}c</span>
            </div>
            <div>
              <span className="text-white/50 block">60 min</span>
              <span className="text-white">Video: {video60Rate}c</span>
              <span className="text-white/50 block">Audio: {audio60Rate}c</span>
            </div>
            <div>
              <span className="text-white/50 block">90 min</span>
              <span className="text-white">Video: {video90Rate}c</span>
              <span className="text-white/50 block">Audio: {audio90Rate}c</span>
            </div>
          </div>
        </div>
      </CardContent>
    </Card>
  );
}
